# CONTRIBUTING to Flex

## Introduction

Thanks for your interest in contributing to Flex! Flex's [issue tracker](https://github.com/westes/flex/issues) is on GitHub. That's the best place to find a task that needs attention. It's also the best place to check whether a problem you've found is known to the community.

## Baseline Build Environment

The maintenance baseline build environment is Ubuntu 20.04 LTS with at least the following packages installed:
- bash
- gcc
- m4
- autoconf
- automake
- make
- bison
- gettext
- autopoint
- help2man
- tar
- gzip
- lzip
- texinfo
- texlive
- indent
- flex (flex bootstraps itself from its previous version)

Configuring your Flex development environment to match the maintenance baseline will help you collaborate and review contributions with the other developers working on Flex.

## Branching Convention

Flex source code is maintained in Git at GitHub. Each Flex developer forks their own copy of the main repository at [westes/flex](https://github.com/westes/flex). Flex development occurs in feature branches of the forks. PRs will eventually be submitted from the feature branches of the forks to westes/flex. 

Flex development forks are not required to reside on GitHub, merely on a publicly-accessible Git server. However:
- GitHub's pull request (PR) process only works with repositories hosted on GitHub;
- Flex's automated testing pipeline depends on GitHub's Actions infrastructure and may not function on other Git servers.

NB: If you cannot use GitHub, another developer can help you import your changes to a GitHub name space using multiple remotes. The details are beyond the scope of this manual.

## Maintaining the Test Suite

### Introduction to Flex Tests
Flex includes an extensive test suite in the `tests/` directory. It includes functional tests as well as regression tests. If you add a feature to Flex, develop corresponding tests for the correct behaviors. Whenever you develop a bug fix, develop a corresponding test for the incorrect behavior to expose future regressions.

The test suite is controlled by `tests/Makefile.am`. Each test consists of a Flex scanner specification, `<category>.l`, that exercises the behavior under test as specifically as possible and an input text file, `<category>.txt`, containing strings for the test scanner to recognize. Flex tests return 0 (zero) on success and 1 (or non-zero) on failure. Test return values are generated by a main() function defined in the test scanner.

In some cases, the test scanner files are generated from a `<category>.rules` file. The file names of generated test scanners are annotated with the combination of conditions they test, like `<category>_nr.l` and `<category>_r.l` for 'non re-entrant' and 're-entrant' versions of a test scanner. Any test scanner is permitted to include annotations in its file name to clarify the conditions that it tests. For example `<category>_c99.l` indicates the test scanner emits C99 actions and should only be used with the C skeleton.

Functional tests, like those testing the combinations of options and their values, are typically implemented in the `<category>.rules` files. Make rules that generate and execute tests from the `<category>.rules` files are found toward the end of `tests/Makefile.am`. Regression tests (and few complex functional tests) are  typically implemented in the `<category>.l` files. 

Every test that gets executed can be traced to the `check_PROGRAMS` list in `tests/Makefile.am`. Each test is associated with a log compiler. The default `LOG_COMPILER` executes any test with a file name that does not include one of the `TEXT_EXTENSIONS`. Specialized log compilers (e.g. `I3_LOG_COMPILER`) for each of the `TEXT_EXTENSIONS` execute their associated tests. The specialized log compilers mostly execute the generated, functional tests. The default log compiler mostly runs the regression tests (see the `SPORADIC_TESTS` list).

### Adding a Regression Test

1. Add `<category>.l` and `<category>.txt` to `tests/`.
2. Add `<category>` to `SPORADIC_TESTS` in `tests/Makefile.am`. (Add a `TEXT_EXTENSIONS` suffix and use the specialized log compiler list if appropriate.)
3. Add `<category>_SOURCES = <category>.l` to `tests/Makefile.am`.
4. Add `<category>.c` and `<category>.h` to `CLEANFILES` in `tests/Makefile.am`. (Add or adjust suffixes to match the target languages.)
5. Add `<category>.txt` to `EXTRA_DIST` in `tests/Makefile.am`.

### Adding a Functional Test

Develop your functional tests the same way you develop regression tests. 

TBD: Refactoring functional tests into `<category>.rules` files. 

## Preparing Your Commits

Small PRs are easier to review and merge into the main branch. Minimize the scope of the changes in a single PR within reason. Changes that touch one or two files are likely to be reviewed and accepted more quickly than changes that touch every file in Flex.

Format your commit messages following [Conventional Commits 1.0.0](https://www.conventionalcommits.org/en/v1.0.0/) (CC BY 3.0 netlify.com). Briefly:

    <type>[(optional scope)][!]: <description>
	[BLANK LINE]
	[optional body]
	[BLANK LINE]
	[optional footer(s)]

A typical commit message might look like:

    docs: Add CONTRIBUTING manual
	
	Refs: #1234

The description should summarize the changes in a single, short sentence. The description should be imperative, like the descriptions of the types below.

The primary types are:
- fix: Fix a bug or incorrect behavior
- feat: Add a new feature
- docs: Update the package documentation
- test: Change or add to the test suite
- refactor: Simplify maintainability without affecting performance or behavior
- perf: Improve performance of a feature
- style: Correct a style mismatch (indentation, etc.)
- build: Change the build system, including tracking external dependencies
- ci: Change the CI/CD system
- revert: Revert a previous commit

The optional scope must appear in parentheses and must consist of a noun describing the section of the code base that was changed.

    docs(contrib): Update URLs in CONTRIBUTING manual

The optional `!` must appear before the description whenever the commit introduces a breaking change - one that breaks compatibility with previous versions of the code base. Whenever the `!` marker appears, a BREAKING-CHANGE footer should also be included.

The optional body may be included to provided additional information or context about the change. If it appears, it must be preceded by a blank line.

The optional footers may be included to provide additional referential information and links to tracked issues, PRs, etc. Each footer must be preceded by a blank line. Footers must be formatted as `<footer-type>: <description>`, similar to the first line of commit messages. The description's format depends upon the footer-type. Known footer-types include:
- Refs: A comma-separated list of commit hashes and/or issue and PR numbers. Issue and PR numbers must be prefixed with a `#`.
- BREAKING-CHANGE: A description of the change that breaks compatibility with previous versions of the code, including the version number at which compatibility is broken. 

A breaking change commit message might look like:

    feat!: Switch to quantum scanner
    
    BREAKING-CHANGE: New scanner runs in constant time but doesn't support any existing hardware. 
	Breaks compatibility with 1.0.0.

Do not squash your commits unless requested by the maintainer. This aids discussion and revision during the review process.


## Submitting PRs

Before submitting a PR to westes/flex, test your changes either locally or using the GitHub Actions pipeline.

### Testing locally

1. Commit and/or stash your changes.
1. Clean your working copy using

    `git clean -xdf`

1. Bootstrap the autotools using

    `./autogen.sh`

1. OPTIONAL: Switch to your build directory of choice. Adjust the path to configure below as necessary.
1. `./configure`
1. `make`
1. `make distcheck`

If `make distcheck` succeeds, it will produce a distribution tarball in the `flex-<version>/` directory of your build tree. If it does not succeed, correct any error messages you see starting at the top of the output. Start again at step 1 after committing any changes.

### Testing with GitHub Actions

If you created a fork of Flex on GitHub, any PR you make to your own main branch will trigger the build and test pipeline.

1. Commit your changes.
1. Push your local branch to your remote at GitHub. Assuming your GitHub remote is called origin:

    `git push origin feature_branch`

1. Open your GitHub Flex repository in your web browser.
1. Click the 'Pull requests' link.
1. Click the 'New pull request' button.
1. Change the 'base repository' from 'westes/flex' to your fork.
1. Change the 'base' branch to 'master' if it isn't already set.
1. Change the 'compare' branch to your feature branch.
1. Click the 'Create pull request' button.
1. Click the 'Actions' link to monitor the progress of your build and test job.

### Submitting PRs to westes/flex

Sending a PR to westes/flex follows nearly the same process as sending one to your own main branch.

1. Commit your changes.
1. Push your local branch to your remote at GitHub. Assuming your GitHub remote is called origin:

    `git push origin feature_branch`

1. Open your GitHub Flex repository in your web browser.
1. Click the 'Pull requests' link.
1. Click the 'New pull request' button.
1. Change the 'base repository' to 'westes/flex'.
1. Change the 'base' branch to 'master' if it isn't already set.
1. Change the 'compare' branch to your feature branch.
1. Click the 'Create pull request' button.
1. Add notes to your PR including 
    - A title or commit-like message
	- A summary of the commits in your pull request 
    - Issue numbers your PR covers 
	- Links to your GitHub Actions test results or a copy of the last few lines of output from your local test results.

If this is your first contribution to Flex, execution of the Actions pipeline will have to be manually approved. If you are a returning contributor, you can click the Actions link to watch your job run.

Keep an eye on your PR's discussion page and your email for review notes and questions from other developers. 

Thanks for contributing!
